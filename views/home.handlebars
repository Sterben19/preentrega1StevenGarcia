<div class="container py-4">
  <h1 class="text-center mb-4">Productos Destacados</h1>

  {{#if products}}
    {{#if products.length}}
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
        {{#each products}}
          <div class="col">
            <div class="card h-100 shadow">
              <div id="carousel-{{_id}}" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                  {{#each thumbnails}}
                    <div class="carousel-item {{#if @first}}active{{/if}}">
                      <img src="{{this}}" class="d-block w-100 p-2" 
                           alt="{{../title}}" style="height: 200px; object-fit: contain;"
                           onerror="this.onerror=null; this.src='/img/default-product.png'">
                    </div>
                  {{/each}}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{_id}}" data-bs-slide="prev">
                  <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{_id}}" data-bs-slide="next">
                  <span class="carousel-control-next-icon"></span>
                </button>
              </div>

              <div class="card-body">
                <h5 class="card-title">{{title}}</h5>
                <p class="text-success fw-bold">{{formatPrice price}}</p>
                <div class="d-flex flex-wrap gap-1 mb-2">
                  <span class="badge bg-primary">{{category}}</span>
                  {{#if (gt stock 0)}}
                    <span class="badge bg-success">Disponible</span>
                  {{else}}
                    <span class="badge bg-danger">Agotado</span>
                  {{/if}}
                </div>
              </div>

              <div class="card-footer bg-white">
                <button onclick="addToCart('{{_id}}', '{{../cartId}}')" 
                        class="btn btn-success w-100" {{#unless stock}}disabled{{/unless}}>
                  <i class="fas fa-cart-plus me-1"></i> Agregar
                </button>
              </div>
            </div>
          </div>
        {{/each}}
      </div>
    {{else}}
      <div class="alert alert-info text-center py-4">
        <i class="fas fa-info-circle fa-3x mb-3"></i>
        <h3>No hay productos disponibles</h3>
        <a href="/products" class="btn btn-outline-primary mt-3">Ver todos los productos</a>
      </div>
    {{/if}}
  {{else}}
    <div class="alert alert-warning text-center py-4">
      <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
      <h3>Error al cargar productos</h3>
      <button onclick="window.location.reload()" class="btn btn-outline-primary mt-3">Recargar p√°gina</button>
    </div>
  {{/if}}
</div>

<script>
async function addToCart(productId, cartId) {
  const btn = event.target;
  try {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Procesando...';

    const response = await fetch(`/api/carts/${cartId}/products/${productId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });

    if (!response.ok) throw new Error('Error al agregar al carrito');

    const counter = document.getElementById('cart-counter');
    if (counter) counter.textContent = parseInt(counter.textContent) + 1;

    showAlert('Producto agregado al carrito', 'success');

  } catch (error) {
    console.error('Error:', error);
    showAlert(error.message, 'danger');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-cart-plus me-1"></i> Agregar';
  }
}
</script>
