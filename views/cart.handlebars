<div class="container py-5">
  <h1 class="mb-4">Carrito de Compras</h1>

  {{#if cart.products.length}}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Precio</th>
            <th>Cantidad</th>
            <th>Subtotal</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {{#each cart.products}}
            <tr data-product-id="{{this.product._id}}">
              <td>{{this.product.title}}</td>
              <td>${{this.product.price}}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary decrease-btn">-</button>
                <span class="mx-2 quantity">{{this.quantity}}</span>
                <button class="btn btn-sm btn-outline-secondary increase-btn">+</button>
              </td>
              <td>${{multiply this.product.price this.quantity}}</td>
              <td>
                <button class="btn btn-danger btn-sm remove-btn">Eliminar</button>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>

    <div class="mt-4 text-end">
      <h4>Total: <span id="cart-total">${{cart.total}}</span></h4>
      <button class="btn btn-warning clear-cart-btn">Vaciar Carrito</button>
    </div>
  {{else}}
    <p>No tienes productos en tu carrito.</p>
  {{/if}}
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cartId = "{{cart._id}}";

    async function updateQuantity(productId, quantity) {
      const response = await fetch(`/api/carts/${cartId}/products/${productId}`, { // <-- corregido a plural
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ quantity })
      });

      if (response.ok) {
        location.reload();
      } else {
        console.error("Error actualizando cantidad:", await response.json());
      }
    }

    document.querySelectorAll(".increase-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const row = btn.closest("tr");
        const productId = row.dataset.productId;
        const quantityEl = row.querySelector(".quantity");
        const quantity = parseInt(quantityEl.textContent) + 1;
        updateQuantity(productId, quantity);
      });
    });

    document.querySelectorAll(".decrease-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const row = btn.closest("tr");
        const productId = row.dataset.productId;
        const quantityEl = row.querySelector(".quantity");
        const quantity = parseInt(quantityEl.textContent) - 1;
        if (quantity < 1) return;
        updateQuantity(productId, quantity);
      });
    });

    document.querySelectorAll(".remove-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        const row = btn.closest("tr");
        const productId = row.dataset.productId;

        const response = await fetch(`/api/carts/${cartId}/products/${productId}`, { method: "DELETE" }); // <-- corregido a plural
        if (response.ok) {
          location.reload();
        } else {
          console.error("Error eliminando producto:", await response.json());
        }
      });
    });

    document.querySelector(".clear-cart-btn")?.addEventListener("click", async () => {
      const response = await fetch(`/api/carts/${cartId}`, { method: "DELETE" });
      if (response.ok) {
        location.reload();
      } else {
        console.error("Error vaciando carrito:", await response.json());
      }
    });
  });
</script>
